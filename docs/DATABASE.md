# üóÑÔ∏è Banco de Dados e Arquitetura

Documenta√ß√£o completa sobre o schema do banco de dados, relacionamentos e estrutura.

---

## üìã **√çNDICE**

1. [Vis√£o Geral](#-vis√£o-geral)
2. [M√≥dulos e Tabelas](#-m√≥dulos-e-tabelas)
3. [Schema Completo](#-schema-completo)
4. [Relacionamentos](#-relacionamentos)
5. [Migra√ß√µes](#-migra√ß√µes)
6. [Boas Pr√°ticas](#-boas-pr√°ticas)
7. [Seed Data](#-seed-data)

---

## üéØ **VIS√ÉO GERAL**

O **Silo** utiliza **PostgreSQL** com **Drizzle ORM** para gerenciamento do banco de dados.

- **Database:** PostgreSQL
- **ORM:** Drizzle ORM 0.43.1
- **Schema:** `src/lib/db/schema.ts`
- **Total de Tabelas:** 25
- **M√≥dulos:** 8 principais

---

## üì¶ **M√ìDULOS E TABELAS**

| M√≥dulo | Tabelas | Descri√ß√£o |
|--------|---------|-----------|
| **Autentica√ß√£o** | 5 | Usu√°rios, sess√µes, c√≥digos OTP, provedores OAuth, rate limiting |
| **Perfis** | 2 | Perfis e prefer√™ncias dos usu√°rios |
| **Grupos** | 2 | Grupos e relacionamento many-to-many com usu√°rios |
| **Produtos** | 11 | Produtos, problemas, solu√ß√µes, depend√™ncias, contatos, manuais, atividades |
| **Chat** | 2 | Mensagens e presen√ßa de usu√°rios |
| **Projetos** | 5 | Projetos, atividades, tarefas, usu√°rios e hist√≥rico |
| **Ajuda** | 1 | Documenta√ß√£o do sistema |
| **Contatos** | 1 | Base de contatos globais |

---

## üìä **SCHEMA COMPLETO**

### **Autentica√ß√£o**

#### `auth_user`

```typescript
{
  id: text (PK),
  name: text,
  email: text (UK),
  emailVerified: boolean,
  password: text,
  image: text,
  isActive: boolean,
  lastLogin: timestamp,
  createdAt: timestamp
}
```

#### `auth_session`

```typescript
{
  id: text (PK),
  userId: text (FK ‚Üí auth_user),
  token: text,
  expiresAt: timestamp
}
```

#### `auth_code`

```typescript
{
  id: text (PK),
  userId: text (FK ‚Üí auth_user),
  code: text,
  email: text,
  expiresAt: timestamp
}
```

#### `auth_provider`

```typescript
{
  id: text (PK),
  userId: text (FK ‚Üí auth_user),
  googleId: text
}
```

#### `rate_limit`

```typescript
{
  id: text (PK),
  route: text,
  email: text,
  ip: text,
  count: integer,
  lastRequest: timestamp
}
Constraint: unique(email, ip, route)
```

### **Perfis**

#### `user_profile`

```typescript
{
  id: text (PK),
  userId: text (FK ‚Üí auth_user),
  genre: text,
  phone: text,
  role: text,
  team: text,
  company: text,
  location: text
}
```

#### `user_preferences`

```typescript
{
  id: text (PK),
  userId: text (FK ‚Üí auth_user),
  chatEnabled: boolean
}
```

### **Grupos**

#### `group`

```typescript
{
  id: text (PK),
  name: text (UK),
  description: text,
  icon: text,
  color: text,
  active: boolean,
  isDefault: boolean,
  maxUsers: integer,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### `user_group`

```typescript
{
  id: uuid (PK),
  userId: text (FK ‚Üí auth_user),
  groupId: text (FK ‚Üí group),
  role: text,
  joinedAt: timestamp,
  createdAt: timestamp
}
Constraint: unique(userId, groupId)
```

### **Produtos**

#### `product`

```typescript
{
  id: text (PK),
  name: text,
  slug: text (UK),
  available: boolean,
  priority: text,
  turns: jsonb,
  description: text
}
```

#### `product_activity`

```typescript
{
  id: uuid (PK),
  productId: text (FK ‚Üí product),
  userId: text (FK ‚Üí auth_user),
  date: date,
  turn: integer,
  status: text,
  problemCategoryId: text (FK ‚Üí product_problem_category),
  description: text,
  createdAt: timestamp,
  updatedAt: timestamp
}
Constraint: unique(productId, date, turn)
```

#### `product_activity_history`

```typescript
{
  id: uuid (PK),
  productActivityId: uuid (FK ‚Üí product_activity),
  userId: text (FK ‚Üí auth_user),
  status: text,
  description: text,
  createdAt: timestamp
}
```

#### `product_problem_category`

```typescript
{
  id: text (PK),
  name: text (UK),
  color: text,
  isSystem: boolean,
  sortOrder: integer,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### `product_problem`

```typescript
{
  id: text (PK),
  productId: text (FK ‚Üí product),
  userId: text (FK ‚Üí auth_user),
  title: text,
  description: text,
  problemCategoryId: text (FK ‚Üí product_problem_category),
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### `product_problem_image`

```typescript
{
  id: text (PK),
  productProblemId: text (FK ‚Üí product_problem),
  image: text,
  description: text
}
```

#### `product_solution`

```typescript
{
  id: text (PK),
  userId: text (FK ‚Üí auth_user),
  productProblemId: text (FK ‚Üí product_problem),
  description: text,
  replyId: text (FK ‚Üí product_solution),
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### `product_solution_checked`

```typescript
{
  id: text (PK),
  userId: text (FK ‚Üí auth_user),
  productSolutionId: text (FK ‚Üí product_solution)
}
```

#### `product_dependency`

```typescript
{
  id: text (PK),
  productId: text (FK ‚Üí product),
  name: text,
  icon: text,
  description: text,
  parentId: text (FK ‚Üí product_dependency),
  treePath: text,
  treeDepth: integer,
  sortKey: text,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### `product_manual`

```typescript
{
  id: text (PK),
  productId: text (FK ‚Üí product),
  description: text,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### `product_contact`

```typescript
{
  id: text (PK),
  productId: text (FK ‚Üí product),
  contactId: text (FK ‚Üí contact),
  createdAt: timestamp
}
```

### **Contatos**

#### `contact`

```typescript
{
  id: text (PK),
  name: text,
  role: text,
  team: text,
  email: text (UK),
  phone: text,
  image: text,
  active: boolean,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### **Chat**

#### `chat_message`

```typescript
{
  id: uuid (PK),
  content: text,
  senderUserId: text (FK ‚Üí auth_user),
  receiverGroupId: text (FK ‚Üí group) (NULL ou v√°lido),
  receiverUserId: text (FK ‚Üí auth_user) (NULL ou v√°lido),
  readAt: timestamp,
  createdAt: timestamp,
  updatedAt: timestamp,
  deletedAt: timestamp
}
Constraint: receiverGroupId OU receiverUserId (nunca ambos)
```

#### `chat_user_presence`

```typescript
{
  userId: text (PK-FK ‚Üí auth_user),
  status: text,
  lastActivity: timestamp,
  updatedAt: timestamp
}
```

### **Projetos**

#### `project`

```typescript
{
  id: uuid (PK),
  name: text,
  shortDescription: text,
  description: text,
  startDate: date,
  endDate: date,
  priority: text,
  status: text,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### `project_activity`

```typescript
{
  id: uuid (PK),
  projectId: uuid (FK ‚Üí project),
  name: text,
  description: text,
  category: text,
  estimatedDays: integer,
  startDate: date,
  endDate: date,
  priority: text,
  status: text,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### `project_task`

```typescript
{
  id: uuid (PK),
  projectId: uuid (FK ‚Üí project),
  projectActivityId: uuid (FK ‚Üí project_activity),
  name: text,
  description: text,
  category: text,
  estimatedDays: integer,
  startDate: date,
  endDate: date,
  priority: text,
  status: text,
  sort: integer,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### `project_task_user`

```typescript
{
  id: uuid (PK),
  taskId: uuid (FK ‚Üí project_task),
  userId: text (FK ‚Üí auth_user),
  role: text,
  assignedAt: timestamp,
  createdAt: timestamp
}
Constraint: unique(taskId, userId)
```

#### `project_task_history`

```typescript
{
  id: uuid (PK),
  taskId: uuid (FK ‚Üí project_task),
  userId: text (FK ‚Üí auth_user),
  action: text,
  fromStatus: text,
  toStatus: text,
  fromSort: integer,
  toSort: integer,
  details: jsonb,
  createdAt: timestamp
}
```

### **Ajuda**

#### `help`

```typescript
{
  id: text (PK),
  description: text (Markdown),
  createdAt: timestamp,
  updatedAt: timestamp
}
```

---

## üîó **RELACIONAMENTOS**

### **Autentica√ß√£o e Usu√°rios**

```text
auth_user (1) ‚Üí (N) user_profile
auth_user (1) ‚Üí (N) user_preferences
auth_user (1) ‚Üí (N) auth_session
auth_user (N) ‚Üî (N) group via user_group
```

### **Produtos**

```text
product (1) ‚Üí (N) product_activity
product (1) ‚Üí (N) product_problem
product (1) ‚Üí (N) product_dependency
product (1) ‚Üí (1) product_manual
product (N) ‚Üî (N) contact via product_contact

product_problem (1) ‚Üí (N) product_solution
product_problem (1) ‚Üí (N) product_problem_image
product_solution (1) ‚Üí (N) product_solution_image
```

### **Projetos e Kanban**

```text
project (1) ‚Üí (N) project_activity ‚Üí (N) project_task
project_task (N) ‚Üî (N) auth_user via project_task_user
project_task (1) ‚Üí (N) project_task_history
```

### **Chat**

```text
chat_message (N) ‚Üí (1) auth_user (sender)
chat_message (N) ‚Üí (1) group (grupo) OU auth_user (DM)
```

---

## üîÑ **MIGRA√á√ïES**

### **Comandos Drizzle**

```bash
# Gerar migra√ß√£o a partir do schema
npm run db:generate

# Aplicar migra√ß√µes no banco
npm run db:migrate

# Visualizar banco de dados (GUI)
npm run db:studio

# Push direto do schema (desenvolvimento)
npm run db:push
```

### **Arquivos de Migra√ß√£o**

Localizados em `/drizzle/` com versionamento autom√°tico:

```text
drizzle/
‚îú‚îÄ‚îÄ 0000_pale_red_skull.sql
‚îú‚îÄ‚îÄ 0001_low_kitty_pryde.sql
‚îî‚îÄ‚îÄ meta/
    ‚îú‚îÄ‚îÄ _journal.json
    ‚îú‚îÄ‚îÄ 0000_snapshot.json
    ‚îî‚îÄ‚îÄ 0001_snapshot.json
```

---

## ‚úÖ **BOAS PR√ÅTICAS**

### **1. √çndices Otimizados**

Todas as FK t√™m √≠ndices para performance:

```typescript
export const sessions = pgTable('auth_session', {
  userId: text('user_id').notNull().references(() => users.id, {
    onDelete: 'cascade'
  }).index()
})
```

### **2. Constraints √önicos**

Previnem duplica√ß√µes:

```typescript
// Email √∫nico
email: text('email').notNull().unique()

// Dupla constraint
constraint uniqueProductActivity = unique(
  productActivity.productId,
  productActivity.date,
  productActivity.turn
)
```

### **3. Soft Delete**

Campo `deletedAt` onde necess√°rio:

```typescript
deletedAt: timestamp('deleted_at')

// Query ignorando deletados
.where(isNull(chatMessages.deletedAt))
```

### **4. Timestamps**

Criado e atualizado em todas as tabelas principais:

```typescript
createdAt: timestamp('created_at').defaultNow(),
updatedAt: timestamp('updated_at').defaultNow()
```

### **5. Cascade Delete**

Relacionamentos com `onDelete: 'cascade'`:

```typescript
userId: text('user_id')
  .notNull()
  .references(() => users.id, { onDelete: 'cascade' })
```

### **6. Tipagem TypeScript**

Types gerados automaticamente:

```typescript
import type { InferSelectModel, InferInsertModel } from 'drizzle-orm'

export type User = InferSelectModel<typeof users>
export type NewUser = InferInsertModel<typeof users>
```

### **7. JSONB para Dados Flex√≠veis**

Campos complexos como JSONB:

```typescript
turns: jsonb('turns').$type<{
  morning: boolean
  afternoon: boolean
  night: boolean
}>()

details: jsonb('details').$type<Record<string, unknown>>()
```

### **8. UUID para Alta Concorr√™ncia**

IDs onde h√° muitas inser√ß√µes concorrentes:

```typescript
id: uuid('id').defaultRandom().primaryKey()
```

---

## üå± **SEED DATA**

### **Grupos Padr√£o**

```typescript
const defaultGroups = [
  { id: 'admins', name: 'Administradores', icon: 'shield', color: 'red' },
  { id: 'meteorologists', name: 'Meteorologistas', icon: 'cloud', color: 'blue' },
  { id: 'analysts', name: 'Analistas', icon: 'users', color: 'green' },
  { id: 'developers', name: 'Desenvolvedores', icon: 'code', color: 'purple' },
  { id: 'support', name: 'Suporte', icon: 'headphones', color: 'orange' },
  { id: 'visitors', name: 'Visitantes', icon: 'eye', color: 'gray' }
]
```

### **Categorias de Problemas Padr√£o**

```typescript
const defaultCategories = [
  { id: 'network', name: 'Rede', color: 'red' },
  { id: 'hardware', name: 'Hardware', color: 'orange' },
  { id: 'software', name: 'Software', color: 'blue' },
  { id: 'data', name: 'Dados', color: 'green' }
]
```

### **Executar Seed**

```bash
npm run db:seed
```

---

## üìä **Estrutura H√≠brida de Depend√™ncias**

O campo `product_dependency` usa 3 t√©cnicas combinadas:

1. **Adjacency List:** `parentId` - Hierarquia direta
2. **Path Enumeration:** `treePath` - Caminho completo
3. **Nested Sets:** `sortKey` - Ordena√ß√£o eficiente

**Exemplo:**

```
product_dependency
‚îú‚îÄ‚îÄ Server (parentId: null, treePath: '1', sortKey: '001')
‚îÇ   ‚îú‚îÄ‚îÄ Web Server (parentId: 'server', treePath: '1.1', sortKey: '001.001')
‚îÇ   ‚îî‚îÄ‚îÄ DB Server (parentId: 'server', treePath: '1.2', sortKey: '001.002')
‚îî‚îÄ‚îÄ Network (parentId: null, treePath: '2', sortKey: '002')
```

**Benef√≠cios:**

- Query r√°pida com Path Enumeration
- Ordena√ß√£o eficiente com Nested Sets
- Inser√ß√£o simples com Adjacency List

---

**üéØ Schema completo em: `src/lib/db/schema.ts`**
