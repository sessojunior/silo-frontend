import { test, expect } from './utils/auth-helpers'

test.describe('üìã SISTEMA DE PROJETOS E KANBAN', () => {
	test.describe('üìÅ Gest√£o de Projetos', () => {
		test('‚úÖ CRUD de projetos - criar/editar/excluir', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Verificar se p√°gina carregou
			await expect(authenticatedPage.getByRole('heading', { name: /projetos/i })).toBeVisible()

			// Clicar em criar novo projeto
			await authenticatedPage.getByRole('button', { name: /criar|novo/i }).click()

			// Verificar se formul√°rio abriu
			await expect(authenticatedPage.getByLabel('Nome do projeto')).toBeVisible()

			// Preencher dados do projeto
			await authenticatedPage.getByLabel('Nome do projeto').fill('Projeto Teste Playwright')
			await authenticatedPage.getByLabel('Descri√ß√£o').fill('Descri√ß√£o do projeto de teste')
			await authenticatedPage.getByLabel('Data de in√≠cio').fill('2024-01-01')
			await authenticatedPage.getByLabel('Data de fim').fill('2024-12-31')
			await authenticatedPage.getByRole('combobox', { name: /prioridade/i }).selectOption('alta')

			// Salvar projeto
			await authenticatedPage.getByRole('button', { name: 'Salvar' }).click()

			// Verificar toast de sucesso
			await expect(authenticatedPage.getByText(/projeto criado|salvo com sucesso/i)).toBeVisible()

			// Verificar se projeto aparece na lista
			await expect(authenticatedPage.getByText('Projeto Teste Playwright')).toBeVisible()
		})

		test('‚úÖ Filtros e busca - funcionam corretamente', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Verificar se campo de busca est√° vis√≠vel
			await expect(authenticatedPage.getByPlaceholder(/buscar|pesquisar/i)).toBeVisible()

			// Buscar por nome
			await authenticatedPage.getByPlaceholder(/buscar|pesquisar/i).fill('teste')

			// Aguardar resultados
			await authenticatedPage.waitForTimeout(1000)

			// Verificar se resultados aparecem
			const searchResults = authenticatedPage.locator('[data-testid="project-item"]')
			if ((await searchResults.count()) > 0) {
				await expect(searchResults.first()).toBeVisible()
			}

			// Limpar busca
			await authenticatedPage.getByPlaceholder(/buscar|pesquisar/i).clear()

			// Verificar se lista original voltou
			await expect(authenticatedPage.locator('[data-testid="project-item"]')).toBeVisible()
		})

		test('‚úÖ Estat√≠sticas - progresso e m√©tricas', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Verificar se estat√≠sticas est√£o vis√≠veis
			await expect(authenticatedPage.getByText(/total de projetos|projetos ativos/i)).toBeVisible()

			// Verificar se contadores s√£o n√∫meros v√°lidos
			const totalProjects = authenticatedPage.locator('[data-testid="total-projects"]')
			const activeProjects = authenticatedPage.locator('[data-testid="active-projects"]')

			if ((await totalProjects.count()) > 0) {
				const projectsCount = await totalProjects.textContent()
				expect(parseInt(projectsCount || '0')).toBeGreaterThanOrEqual(0)
			}

			if ((await activeProjects.count()) > 0) {
				const activeCount = await activeProjects.textContent()
				expect(parseInt(activeCount || '0')).toBeGreaterThanOrEqual(0)
			}
		})
	})

	test.describe('üìù Gest√£o de Atividades', () => {
		test('‚úÖ CRUD por projeto - criar/editar/excluir atividades', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Verificar se p√°gina do projeto carregou
				await expect(authenticatedPage.getByRole('heading', { name: /atividades/i })).toBeVisible()

				// Clicar em criar nova atividade
				await authenticatedPage.getByRole('button', { name: /criar|nova/i }).click()

				// Verificar se formul√°rio abriu
				await expect(authenticatedPage.getByLabel('Nome da atividade')).toBeVisible()

				// Preencher dados da atividade
				await authenticatedPage.getByLabel('Nome da atividade').fill('Atividade Teste Playwright')
				await authenticatedPage.getByLabel('Descri√ß√£o').fill('Descri√ß√£o da atividade de teste')
				await authenticatedPage.getByRole('combobox', { name: /prioridade/i }).selectOption('m√©dia')

				// Salvar atividade
				await authenticatedPage.getByRole('button', { name: 'Salvar' }).click()

				// Verificar toast de sucesso
				await expect(authenticatedPage.getByText(/atividade criada|salva com sucesso/i)).toBeVisible()
			}
		})

		test('‚úÖ Associa√ß√£o projeto-atividade - relacionamento correto', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Verificar se atividades do projeto aparecem
				await expect(authenticatedPage.getByText(/atividades do projeto/i)).toBeVisible()

				// Verificar se lista de atividades est√° vis√≠vel
				const activitiesList = authenticatedPage.locator('[data-testid="activity-item"]')
				if ((await activitiesList.count()) > 0) {
					await expect(activitiesList.first()).toBeVisible()
				}
			}
		})
	})

	test.describe('üéØ Sistema Kanban', () => {
		test('‚úÖ 5 colunas - A Fazer, Em Progresso, Bloqueado, Em Revis√£o, Conclu√≠do', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba do Kanban
				await authenticatedPage.getByRole('tab', { name: /kanban/i }).click()

				// Verificar se colunas est√£o vis√≠veis
				const columns = ['A Fazer', 'Em Progresso', 'Bloqueado', 'Em Revis√£o', 'Conclu√≠do']
				for (const columnName of columns) {
					await expect(authenticatedPage.getByText(columnName)).toBeVisible()
				}

				// Verificar se h√° exatamente 5 colunas
				const kanbanColumns = authenticatedPage.locator('[data-testid="kanban-column"]')
				await expect(kanbanColumns).toHaveCount(5)
			}
		})

		test('‚úÖ Drag & drop - mover entre colunas funciona', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba do Kanban
				await authenticatedPage.getByRole('tab', { name: /kanban/i }).click()

				// Verificar se h√° tarefas para mover
				const tasks = authenticatedPage.locator('[data-testid="kanban-task"]')
				if ((await tasks.count()) > 0) {
					const firstTask = tasks.first()
					const targetColumn = authenticatedPage.locator('[data-testid="kanban-column"]').nth(1) // Em Progresso

					// Simular drag & drop
					await firstTask.dragTo(targetColumn)

					// Aguardar atualiza√ß√£o
					await authenticatedPage.waitForTimeout(1000)

					// Verificar se tarefa foi movida
					const taskText = await firstTask.textContent()
					if (taskText) {
						await expect(targetColumn.locator('[data-testid="kanban-task"]')).toContainText(taskText)
					}
				}
			}
		})

		test('‚úÖ Reordena√ß√£o - dentro da mesma coluna', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba do Kanban
				await authenticatedPage.getByRole('tab', { name: /kanban/i }).click()

				// Verificar se h√° m√∫ltiplas tarefas na mesma coluna
				const firstColumn = authenticatedPage.locator('[data-testid="kanban-column"]').first()
				const tasksInColumn = firstColumn.locator('[data-testid="kanban-task"]')

				if ((await tasksInColumn.count()) > 1) {
					const firstTask = tasksInColumn.first()
					const secondTask = tasksInColumn.nth(1)

					// Simular reordena√ß√£o
					await firstTask.dragTo(secondTask)

					// Aguardar atualiza√ß√£o
					await authenticatedPage.waitForTimeout(1000)

					// Verificar se ordem mudou
					const secondTaskText = await secondTask.textContent()
					if (secondTaskText) {
						await expect(firstColumn.locator('[data-testid="kanban-task"]').first()).toContainText(secondTaskText)
					}
				}
			}
		})

		test('‚úÖ Sincroniza√ß√£o - status sincroniza com project_task', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba do Kanban
				await authenticatedPage.getByRole('tab', { name: /kanban/i }).click()

				// Mover uma tarefa para coluna "Conclu√≠do"
				const tasks = authenticatedPage.locator('[data-testid="kanban-task"]')
				if ((await tasks.count()) > 0) {
					const firstTask = authenticatedPage.locator('[data-testid="kanban-task"]').first()
					const doneColumn = authenticatedPage.locator('[data-testid="kanban-column"]').last() // Conclu√≠do

					// Simular drag & drop
					await firstTask.dragTo(doneColumn)

					// Aguardar atualiza√ß√£o
					await authenticatedPage.waitForTimeout(1000)

					// Verificar se tarefa foi movida
					const firstTaskText = await firstTask.textContent()
					if (firstTaskText) {
						await expect(doneColumn.locator('[data-testid="kanban-task"]')).toContainText(firstTaskText)
					}

					// Ir para aba de atividades para verificar sincroniza√ß√£o
					await authenticatedPage.getByRole('tab', { name: /atividades/i }).click()

					// Verificar se status da tarefa foi atualizado
					const activityItem = authenticatedPage.locator('[data-testid="activity-item"]').first()
					await expect(activityItem.locator('[data-testid="activity-status"]')).toContainText('conclu√≠do')
				}
			}
		})
	})

	test.describe('üìã Gest√£o de Tarefas', () => {
		test('‚úÖ Contagem por atividade - n√∫mero correto de tarefas', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Verificar se contadores de tarefas est√£o vis√≠veis
				const activityItems = authenticatedPage.locator('[data-testid="activity-item"]')
				if ((await activityItems.count()) > 0) {
					const firstActivity = activityItems.first()
					const taskCount = firstActivity.locator('[data-testid="task-count"]')

					if ((await taskCount.count()) > 0) {
						await expect(taskCount).toBeVisible()

						// Verificar se contagem √© um n√∫mero v√°lido
						const countText = await taskCount.textContent()
						expect(parseInt(countText || '0')).toBeGreaterThanOrEqual(0)
					}
				}
			}
		})

		test('‚úÖ Formul√°rio completo - criar/editar tarefas', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba de atividades
				await authenticatedPage.getByRole('tab', { name: /atividades/i }).click()

				// Clicar em uma atividade
				const activityItem = authenticatedPage.locator('[data-testid="activity-item"]').first()
				if ((await activityItem.count()) > 0) {
					await activityItem.click()

					// Clicar em criar nova tarefa
					await authenticatedPage.getByRole('button', { name: /criar|nova/i }).click()

					// Verificar se formul√°rio abriu
					await expect(authenticatedPage.getByLabel('Nome da tarefa')).toBeVisible()

					// Preencher dados da tarefa
					await authenticatedPage.getByLabel('Nome da tarefa').fill('Tarefa Teste Playwright')
					await authenticatedPage.getByLabel('Descri√ß√£o').fill('Descri√ß√£o da tarefa de teste')
					await authenticatedPage.getByRole('combobox', { name: /prioridade/i }).selectOption('alta')
					await authenticatedPage.getByLabel('Estimativa (horas)').fill('8')

					// Salvar tarefa
					await authenticatedPage.getByRole('button', { name: 'Salvar' }).click()

					// Verificar toast de sucesso
					await expect(authenticatedPage.getByText(/tarefa criada|salva com sucesso/i)).toBeVisible()
				}
			}
		})

		test('‚úÖ Valida√ß√µes - campos obrigat√≥rios', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba de atividades
				await authenticatedPage.getByRole('tab', { name: /atividades/i }).click()

				// Clicar em uma atividade
				const activityItem = authenticatedPage.locator('[data-testid="activity-item"]').first()
				if ((await activityItem.count()) > 0) {
					await activityItem.click()

					// Clicar em criar nova tarefa
					await authenticatedPage.getByRole('button', { name: /criar|nova/i }).click()

					// Tentar salvar sem preencher campos obrigat√≥rios
					await authenticatedPage.getByRole('button', { name: 'Salvar' }).click()

					// Verificar se erro de campo obrigat√≥rio aparece
					await expect(authenticatedPage.getByText(/nome √© obrigat√≥rio|campo obrigat√≥rio/i)).toBeVisible()

					// Preencher campo obrigat√≥rio
					await authenticatedPage.getByLabel('Nome da tarefa').fill('Tarefa V√°lida')

					// Tentar salvar novamente
					await authenticatedPage.getByRole('button', { name: 'Salvar' }).click()

					// Deve salvar com sucesso
					await expect(authenticatedPage.getByText(/tarefa criada|salva com sucesso/i)).toBeVisible()
				}
			}
		})

		test('‚úÖ Exclus√£o - di√°logo de confirma√ß√£o', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba de atividades
				await authenticatedPage.getByRole('tab', { name: /atividades/i }).click()

				// Clicar em uma atividade
				const activityItem = authenticatedPage.locator('[data-testid="activity-item"]').first()
				if ((await activityItem.count()) > 0) {
					await activityItem.click()

					// Verificar se h√° tarefas para excluir
					const tasks = authenticatedPage.locator('[data-testid="task-item"]')
					if ((await tasks.count()) > 0) {
						// Clicar no bot√£o de excluir da primeira tarefa
						const deleteButton = tasks.first().locator('[data-testid="delete-task"]')
						await deleteButton.click()

						// Verificar se dialog de confirma√ß√£o apareceu
						await expect(authenticatedPage.getByText(/confirmar exclus√£o|excluir tarefa/i)).toBeVisible()

						// Cancelar exclus√£o
						await authenticatedPage.getByRole('button', { name: 'Cancelar' }).click()

						// Verificar se dialog fechou
						await expect(authenticatedPage.getByText(/confirmar exclus√£o|excluir tarefa/i)).not.toBeVisible()
					}
				}
			}
		})
	})

	test.describe('üîç Funcionalidades Avan√ßadas', () => {
		test('‚úÖ Integra√ß√£o - tarefas aparecem no Kanban', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba de atividades
				await authenticatedPage.getByRole('tab', { name: /atividades/i }).click()

				// Clicar em uma atividade
				const activityItem = authenticatedPage.locator('[data-testid="activity-item"]').first()
				if ((await activityItem.count()) > 0) {
					await activityItem.click()

					// Criar uma nova tarefa
					await authenticatedPage.getByRole('button', { name: /criar|nova/i }).click()
					await authenticatedPage.getByLabel('Nome da tarefa').fill('Tarefa Kanban Teste')
					await authenticatedPage.getByRole('button', { name: 'Salvar' }).click()

					// Aguardar sucesso
					await expect(authenticatedPage.getByText(/tarefa criada|salva com sucesso/i)).toBeVisible()

					// Ir para aba do Kanban
					await authenticatedPage.getByRole('tab', { name: /kanban/i }).click()

					// Verificar se tarefa aparece na coluna "A Fazer"
					await expect(authenticatedPage.getByText('Tarefa Kanban Teste')).toBeVisible()
				}
			}
		})

		test('‚úÖ Filtros por status e prioridade', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba de atividades
				await authenticatedPage.getByRole('tab', { name: /atividades/i }).click()

				// Verificar se filtros est√£o vis√≠veis
				await expect(authenticatedPage.getByRole('combobox', { name: /status/i })).toBeVisible()
				await expect(authenticatedPage.getByRole('combobox', { name: /prioridade/i })).toBeVisible()

				// Filtrar por status
				await authenticatedPage.getByRole('combobox', { name: /status/i }).selectOption('em_progresso')

				// Verificar se filtro funcionou
				const filteredActivities = authenticatedPage.locator('[data-testid="activity-item"]')
				if ((await filteredActivities.count()) > 0) {
					await expect(filteredActivities.first()).toBeVisible()
				}

				// Limpar filtro
				await authenticatedPage.getByRole('combobox', { name: /status/i }).selectOption('todos')
			}
		})

		test('‚úÖ Busca por nome e descri√ß√£o', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba de atividades
				await authenticatedPage.getByRole('tab', { name: /atividades/i }).click()

				// Verificar se campo de busca est√° vis√≠vel
				await expect(authenticatedPage.getByPlaceholder(/buscar|pesquisar/i)).toBeVisible()

				// Buscar por nome
				await authenticatedPage.getByPlaceholder(/buscar|pesquisar/i).fill('teste')

				// Aguardar resultados
				await authenticatedPage.waitForTimeout(1000)

				// Verificar se resultados aparecem
				const searchResults = authenticatedPage.locator('[data-testid="activity-item"]')
				if ((await searchResults.count()) > 0) {
					await expect(searchResults.first()).toBeVisible()
				}

				// Limpar busca
				await authenticatedPage.getByPlaceholder(/buscar|pesquisar/i).clear()

				// Verificar se lista original voltou
				await expect(authenticatedPage.locator('[data-testid="activity-item"]')).toBeVisible()
			}
		})
	})

	test.describe('üì± UX e Performance', () => {
		test('‚úÖ Responsividade em diferentes resolu√ß√µes', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Testar resolu√ß√£o desktop
			await authenticatedPage.setViewportSize({ width: 1920, height: 1080 })
			await expect(authenticatedPage.getByRole('heading', { name: /projetos/i })).toBeVisible()

			// Testar resolu√ß√£o tablet
			await authenticatedPage.setViewportSize({ width: 768, height: 1024 })
			await expect(authenticatedPage.getByRole('heading', { name: /projetos/i })).toBeVisible()

			// Testar resolu√ß√£o mobile
			await authenticatedPage.setViewportSize({ width: 375, height: 667 })
			await expect(authenticatedPage.getByRole('heading', { name: /projetos/i })).toBeVisible()

			// Voltar para desktop
			await authenticatedPage.setViewportSize({ width: 1920, height: 1080 })
		})

		test('‚úÖ Performance com muitas tarefas', async ({ authenticatedPage }) => {
			await authenticatedPage.goto('/admin/projects')

			// Clicar no primeiro projeto
			const projectItem = authenticatedPage.locator('[data-testid="project-item"]').first()
			if ((await projectItem.count()) > 0) {
				await projectItem.click()

				// Ir para aba do Kanban
				await authenticatedPage.getByRole('tab', { name: /kanban/i }).click()

				// Medir tempo de carregamento
				const startTime = Date.now()

				// Aguardar carregamento completo
				await authenticatedPage.waitForLoadState('networkidle')

				const loadTime = Date.now() - startTime

				// Verificar se carregou em tempo aceit√°vel (menos de 5 segundos)
				expect(loadTime).toBeLessThan(5000)

				console.log(`‚úÖ Kanban carregou em ${loadTime}ms`)
			}
		})
	})
})
