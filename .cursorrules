# ğŸ§  PROTOCOLO CLAUDE AI - PROJETO SILO

## ğŸš¨ PROTOCOLO CRÃTICO DE INICIALIZAÃ‡ÃƒO

Sou um engenheiro de software especialista com memÃ³ria que se reinicia entre sessÃµes. O arquivo **README.md** na raiz do projeto Ã© meu **ÃšNICO ELO** com trabalho anterior e DEVE ser consultado no inÃ­cio de CADA conversaÃ§Ã£o.

**ğŸ”¥ OBRIGATÃ“RIO**: Sempre ler README.md antes de qualquer implementaÃ§Ã£o - isso NÃƒO Ã© opcional!

---

## ğŸ“‚ ARQUIVO CENTRAL DE MEMÃ“RIA

### LocalizaÃ§Ã£o Principal

**Arquivo**: `/README.md` (arquivo Ãºnico consolidado)

#### ğŸ“‹ ARQUIVO PRINCIPAL

**`README.md`** - **PONTO DE ENTRADA OBRIGATÃ“RIO**

- Protocolo de trabalho completo
- Status atual e prÃ³ximas prioridades
- Estrutura arquitetural completa
- PadrÃµes tÃ©cnicos estabelecidos
- Funcionalidades implementadas
- Credenciais e comandos essenciais
- **SEMPRE ler PRIMEIRO em toda sessÃ£o**

---

## âš¡ PROTOCOLO DE TRABALHO

### ğŸ¯ Ao Iniciar QUALQUER SessÃ£o

```
1. LER README.md (OBRIGATÃ“RIO)
2. CONSULTAR arquitetura e status atual
3. VERIFICAR prÃ³ximas prioridades
4. APLICAR padrÃµes estabelecidos
5. CONSIDERAR contexto completo do projeto
```

### ğŸ”„ Para Cada Tarefa

```
1. CONSULTAR README.md ANTES de implementar
2. APLICAR padrÃµes estabelecidos documentados
3. ATUALIZAR README.md quando necessÃ¡rio
4. DOCUMENTAR mudanÃ§as significativas
```

---

## ğŸ› ï¸ PADRÃ•ES ESTABELECIDOS

### ğŸ“ Imports e Estrutura

- **SEMPRE** usar alias `@/` para imports internos
- **NUNCA** usar caminhos relativos para mÃ³dulos internos
- **SEMPRE** consultar schemas centralizados

### ğŸš¨ Logs Padronizados

- **âœ…** - Sucesso/OperaÃ§Ã£o completada
- **âŒ** - Erro/Falha
- **âš ï¸** - Aviso/AtenÃ§Ã£o
- **ğŸ”µ** - InformaÃ§Ã£o/Log informativo
- **APENAS** estes 4 emojis nos logs

### ğŸ”’ Error Handling

- **SEMPRE** retornar `{ success: boolean, error?: string }`
- **SEMPRE** usar try/catch com logs padronizados

### ğŸ› PROBLEMAS CRÃTICOS RESOLVIDOS

#### **PROBLEMA: Turnos MÃºltiplos NÃ£o Aparecendo no Dashboard**

**Sintoma**: Produtos com mÃºltiplos turnos (ex: SMEC com turnos 0h e 12h) sÃ³ exibiam o primeiro turno no `lastDaysStatus`, mesmo quando o turno 12h estava salvo corretamente no banco.

**Causa Raiz**: No arquivo `src/app/admin/dashboard/page.tsx`, a construÃ§Ã£o do `lastDaysStatus` usava `p.dates.find((d) => d.date === date)` que retorna apenas o PRIMEIRO registro encontrado para cada data, ignorando turnos adicionais.

**SoluÃ§Ã£o Implementada**:

```typescript
// âŒ ANTES (sÃ³ retornava primeiro turno)
const lastDaysStatus = lastDates.map((date) => {
	const dayData = p.dates.find((d) => d.date === date)
	return dayData || { date, turn: 0, user_id: null, status: 'not_run', description: null, alert: false }
})

// âœ… DEPOIS (retorna TODOS os turnos)
const lastDaysStatus = lastDates.flatMap((date) => {
	const dayData = p.dates.filter((d) => d.date === date)
	if (dayData.length === 0) {
		return [{ date, turn: 0, user_id: '', status: 'not_run', description: null, alert: false }]
	}
	return dayData
})
```

**LiÃ§Ã£o Aprendida**:

- **SEMPRE** usar `filter()` quando precisar de mÃºltiplos registros
- **NUNCA** usar `find()` para dados que podem ter mÃºltiplas ocorrÃªncias
- **SEMPRE** verificar se a API retorna dados corretos antes de debugar o frontend

---

## ğŸ”„ MANUTENÃ‡ÃƒO DO README.MD

### â° Quando Atualizar

1. **Descobrir novos padrÃµes** nÃ£o documentados
2. **ApÃ³s implementar mudanÃ§as significativas**
3. **Quando usuÃ¡rio solicitar**: `"atualizar readme.md"`
4. **Quando encontrar inconsistÃªncias** entre cÃ³digo e documentaÃ§Ã£o

### ğŸ“ Como Atualizar

1. **IDENTIFICAR** seÃ§Ã£o que precisa de atualizaÃ§Ã£o
2. **MANTER** estrutura e formato existente
3. **ADICIONAR** informaÃ§Ãµes sem remover existentes
4. **VERIFICAR** consistÃªncia em todo arquivo
5. **FOCAR** em status atual e progressos tÃ©cnicos
6. **NUNCA** incluir datas nos progressos (ex: "DEZEMBRO 2024")

### ğŸ¯ Comando Especial

Quando usuÃ¡rio disser **"atualizar readme.md"**:

- REVISAR arquivo completo README.md
- ATUALIZAR informaÃ§Ãµes desatualizadas
- DOCUMENTAR novo estado do projeto
- MANTER foco em status atual e progress tÃ©cnico
- REMOVER todas as datas dos progressos

---

## ğŸ¯ ESPECIALIZAÃ‡ÃƒO TÃ‰CNICA

### Stack Principal

- **Next.js 15+** (App Router obrigatÃ³rio)
- **React 19** + **TypeScript** (strict mode)
- **Drizzle ORM** + **PostgreSQL**
- **Tailwind CSS** + **Design System customizado**
- **Servidor de Arquivos Local** (Node.js + Express + Multer + Sharp)

### PrincÃ­pios de Desenvolvimento

- **Modularidade**: Sistemas organizados em mÃ³dulos
- **Type Safety**: TypeScript strict em todo projeto, nunca usar any
- **Security by Design**: ValidaÃ§Ã£o em todas camadas
- **Performance First**: Bundle otimizado

---

## ğŸ’¡ INSTRUÃ‡Ã•ES OPERACIONAIS

### âœ… Sempre Fazer

- Consultar README.md ANTES de implementaÃ§Ãµes
- Usar padrÃµes estabelecidos e documentados
- Responder em portuguÃªs brasileiro
- Priorizar simplicidade e legibilidade
- Focar no contexto completo da aplicaÃ§Ã£o

### âŒ Nunca Fazer

- Implementar sem consultar README.md
- Criar padrÃµes novos sem documentar
- Usar caminhos relativos para imports internos
- Duplicar validaÃ§Ãµes ou schemas
- Ignorar .env (sempre considerar correto)
- Incluir datas nos progressos (ex: "DEZEMBRO 2024")
- Usar UploadThing (sistema migrado para servidor local)

---

## ğŸŒŸ PRINCÃPIO FUNDAMENTAL

**O README.md Ã© meu Ãºnico elo com trabalho anterior.** Deve ser mantido com precisÃ£o absoluta. A estrutura otimizada garante navegaÃ§Ã£o rÃ¡pida e informaÃ§Ãµes centralizadas para mÃ¡xima performance de desenvolvimento.

**LEMBRE-SE**: Este .cursorrules Ã© um **protocolo de trabalho**, nÃ£o um repositÃ³rio de detalhes especÃ­ficos. Os detalhes estÃ£o no README.md e devem ser consultados a cada sessÃ£o.

---

## ğŸ“š COMO USAR ESTE PROTOCOLO

1. **Toda nova sessÃ£o**: Ler README.md primeiro
2. **Para implementaÃ§Ãµes**: Consultar estrutura e padrÃµes estabelecidos
3. **Para status**: Verificar funcionalidades implementadas e pendentes
4. **Para contexto**: Revisar arquitetura e princÃ­pios tÃ©cnicos
5. **Para atualizaÃ§Ãµes**: Seguir protocolo de manutenÃ§Ã£o acima

**A eficiÃªncia depende inteiramente da precisÃ£o do README.md.**

---

## ğŸ—‚ï¸ SERVIDOR DE ARQUIVOS LOCAL

### ğŸ“‹ **INFORMAÃ‡Ã•ES CRÃTICAS**

- **STATUS**: âœ… **MIGRAÃ‡ÃƒO COMPLETA** - UploadThing substituÃ­do por servidor local Node.js
- **LOCALIZAÃ‡ÃƒO**: `/fileserver/` - Servidor independente na raiz do projeto
- **STACK**: Express + Multer + Sharp + file-type + UUID
- **OTIMIZAÃ‡ÃƒO**: ConversÃ£o automÃ¡tica para WebP, redimensionamento, thumbnails
- **SEGURANÃ‡A**: ValidaÃ§Ã£o robusta, CORS configurado, limpeza automÃ¡tica

### ğŸš€ **COMANDOS ESSENCIAIS**

```bash
# Desenvolvimento
cd fileserver && npm run dev

# ProduÃ§Ã£o
cd fileserver && npm run pm2

# Health check
curl http://localhost:4000/health
```

### ğŸ”§ **ENDPOINTS PRINCIPAIS**

- `/api/upload` - Upload genÃ©rico (proxy Next.js)
- `/upload/avatar` - Avatar com thumbnail automÃ¡tico
- `/upload/contact` - Fotos de contatos
- `/upload/problem` - Imagens de problemas (mÃºltiplas)
- `/upload/solution` - Imagens de soluÃ§Ãµes (mÃºltiplas)
- `/files/:type/:filename` - Acesso e delete de arquivos

### ğŸ“ **ESTRUTURA DE DIRETÃ“RIOS**

```
fileserver/uploads/
â”œâ”€â”€ avatars/     # Com thumbnails automÃ¡ticos (thumb-*.webp)
â”œâ”€â”€ contacts/    # Fotos de contatos otimizadas
â”œâ”€â”€ problems/    # Imagens de problemas otimizadas
â”œâ”€â”€ solutions/   # Imagens de soluÃ§Ãµes otimizadas
â”œâ”€â”€ general/     # Uploads genÃ©ricos otimizados
â””â”€â”€ temp/        # Arquivos temporÃ¡rios (limpeza automÃ¡tica)
```

### âš ï¸ **IMPORTANTE**

- **NUNCA** usar UploadThing - sistema completamente migrado
- **SEMPRE** usar UploadButtonLocal nos componentes
- **SEMPRE** verificar se servidor estÃ¡ rodando antes de testes
- **SEMPRE** consultar README.md para comandos atualizados
